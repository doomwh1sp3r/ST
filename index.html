<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Smoking Habit Tracker</title>
<style>
  :root {
    --bg: #0f172a;        /* slate-900 */
    --panel: #1f2937;     /* gray-800 */
    --panel-2: #111827;   /* gray-900 */
    --text: #e5e7eb;      /* gray-200 */
    --muted: #9ca3af;     /* gray-400 */
    --accent: #facc15;    /* yellow-400 */
    --green: #22c55e;
    --amber: #f59e0b;
    --red: #ef4444;
    --blue: #3b82f6;
    --border: #374151;    /* gray-700 */
  }
  html, body { height: 100%; }
  body {
    margin: 0; background: var(--bg); color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .container { max-width: 960px; margin: 0 auto; padding: 24px; }
  h1 { text-align: center; color: var(--accent); margin: 0 0 16px; font-size: 28px; }
  .tabs { display: flex; justify-content: center; gap: 8px; margin: 16px 0 24px; }
  .tab { padding: 10px 16px; border-radius: 10px; font-weight: 600; background: var(--panel); color: #ddd; border: 1px solid var(--border); cursor: pointer; }
  .tab.active { background: var(--accent); color: #000; border-color: var(--accent); }
  .row { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 16px; }
  button {
    border: none; border-radius: 10px; padding: 10px 16px; font-weight: 700; cursor: pointer;
    color: #fff; background: var(--panel); border: 1px solid var(--border);
  }
  button:disabled { opacity: .6; cursor: default; }
  .btn-green { background: var(--green); }
  .btn-amber { background: var(--amber); }
  .btn-red { background: var(--red); }
  .btn-blue { background: var(--blue); }
  input[type="time"], input[type="date"], input[type="number"] {
    background: var(--panel); color: #fff; border: 1px solid var(--border);
    padding: 10px 12px; border-radius: 10px;
  }
  /* hide number arrows */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; appearance: textfield; }

  .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
  .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; text-align: center; }
  .card .muted { color: var(--muted); font-size: 12px; }
  .card .big { font-size: 28px; font-weight: 800; }
  .card .small { color: var(--muted); font-size: 12px; margin-top: 6px; }
  .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; margin-top: 12px; }
  .title { color: var(--accent); font-size: 16px; font-weight: 700; margin: 0 0 8px; }
  .list { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
  .li { background: var(--panel-2); border: 1px solid var(--border); border-radius: 12px; padding: 8px 10px; display: flex; justify-content: space-between; align-items: center; }
  .note { color: var(--muted); font-size: 12px; text-align: center; margin-bottom: 6px; }

  /* Chart */
  .chart-wrap { height: 320px; background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 8px; }
  .chart { width: 100%; height: 100%; }
  .axis { stroke: #9ca3af; stroke-width: 1; }
  .grid { stroke: #374151; stroke-width: 1; stroke-dasharray: 3 3; }
  .dot { fill: var(--accent); }
  .tick { fill: #d1d5db; font-size: 11px; }

  /* Modal */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,.6);
    display: none; align-items: center; justify-content: center; z-index: 9999;
  }
  .modal {
    background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
    padding: 16px; max-width: 420px; width: calc(100% - 32px);
    box-shadow: 0 10px 30px rgba(0,0,0,.4);
  }
  .modal h3 { margin: 0 0 10px; font-size: 18px; color: var(--accent); }
  .modal p { margin: 0 0 14px; color: var(--text); }
  .modal .actions { display: flex; justify-content: flex-end; gap: 8px; }
  @media (max-width: 720px) { .stats { grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <div class="container">
    <h1>Smoking Habit Tracker</h1>

    <div class="tabs">
      <button id="tab-today" class="tab active">Today</button>
      <button id="tab-history" class="tab">History</button>
    </div>

    <div id="today-ui">
      <div class="row">
        <button id="btn-smoke" class="btn-green">I Smoked</button>
        <button id="btn-undo" class="btn-amber" disabled>Undo Last</button>
        <button id="btn-reset-today" class="btn-red" disabled>Reset (Today)</button>
        <button id="btn-clear-history" disabled>Clear History</button>
      </div>

      <div class="row">
        <input id="manual-time" type="time" />
        <button id="btn-add-manual" class="btn-blue">Add Manual</button>

        <!-- Cost per cigarette -->
        <input id="cost-input" type="number" inputmode="decimal" step="0.01" min="0" placeholder="Cost per cigarette (e.g. 0.50)" style="width:280px" />
        <button id="btn-save-cost">Save Cost</button>
      </div>

      <div class="stats">
        <div class="card">
          <div class="muted">Today</div>
          <div id="stat-today" class="big">0</div>
          <div id="cost-today" class="small">Cost: 0.00</div>
        </div>
        <div class="card">
          <div class="muted">All Time</div>
          <div id="stat-all" class="big">0</div>
          <div id="cost-all" class="small">Cost: 0.00</div>
        </div>
        <div class="card">
          <div class="muted">Since last smoke</div>
          <div id="since-last" class="big">—</div>
          <div id="since-last-at" class="small"></div>
        </div>
      </div>

      <div class="note">Events over the last 24 hours (midnight → now)</div>
      <div class="chart-wrap"><svg id="chart-today" class="chart"></svg></div>

      <div class="panel">
        <div class="title">Today's Events</div>
        <ul id="list-today" class="list"></ul>
      </div>
    </div>

    <div id="history-ui" style="display:none">
      <div class="row">
        <button id="btn-prev">◀ Prev</button>
        <input id="history-date" type="date" />
        <button id="btn-next">Next ▶</button>
      </div>

      <div class="stats">
        <div class="card">
          <div class="muted">Selected Day</div>
          <div id="stat-selected" class="big">0</div>
          <div id="cost-selected" class="small">Cost: 0.00</div>
        </div>
        <div class="card">
          <div class="muted">All Time</div>
          <div id="stat-all-2" class="big">0</div>
          <div id="cost-all-2" class="small">Cost: 0.00</div>
        </div>
        <div class="card">
          <div class="muted">Date</div>
          <div id="stat-date" class="big" style="font-size:20px"></div>
        </div>
      </div>

      <div class="note">Events for selected date</div>
      <div class="chart-wrap"><svg id="chart-history" class="chart"></svg></div>

      <div class="panel">
        <div class="title">Events on selected date</div>
        <ul id="list-history" class="list"></ul>
      </div>
    </div>
  </div>

  <!-- Reusable modal -->
  <div id="modal-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="modal-title">Please Confirm</h3>
      <p id="modal-message"></p>
      <div class="actions">
        <button id="modal-cancel">Cancel</button>
        <button id="modal-confirm" class="btn-red">Confirm</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const LS_EVENTS = 'habit_smokes_v1';
  const LS_COST   = 'habit_cost_per_cig_v1';

  // --- State ---
  let smokeEvents = [];
  let tab = 'today'; // 'today' | 'history'
  let historyDate = toYYYYMMDD(new Date());
  let nowTs = Date.now();
  let costPerCig = 0; // number

  // live ticker for "since last"
  setInterval(() => { nowTs = Date.now(); render(); }, 1000);

  // --- Helpers ---
  function toYYYYMMDD(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function startOfDay(date) { const d = new Date(date); d.setHours(0,0,0,0); return d.getTime(); }
  function endOfDay(date)   { const d = new Date(date); d.setHours(24,0,0,0); return d.getTime(); }
  const startOfToday = () => startOfDay(new Date());
  const endOfToday   = () => endOfDay(new Date());
  function fmtTime(ts) {
    return new Date(ts).toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
  }
  function fmtCurrency(n) {
    if (!Number.isFinite(n)) n = 0;
    return n.toFixed(2);
  }
  function fmtDuration(ms) {
    if (ms <= 0 || !Number.isFinite(ms)) return '—';
    const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    const pad = n => String(n).padStart(2,'0');
    return hh>0 ? `${hh}h ${pad(mm)}m ${pad(ss)}s` : `${mm}m ${pad(ss)}s`;
  }

  // --- Persistence ---
  try {
    const raw = localStorage.getItem(LS_EVENTS);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) smokeEvents = parsed;
    }
  } catch {}
  try {
    const rawCost = localStorage.getItem(LS_COST);
    if (rawCost != null) {
      const n = Number(rawCost);
      if (!Number.isNaN(n) && n >= 0) costPerCig = n;
    }
  } catch {}

  function saveEvents() {
    try { localStorage.setItem(LS_EVENTS, JSON.stringify(smokeEvents)); } catch {}
  }
  function saveCost() {
    try { localStorage.setItem(LS_COST, String(costPerCig)); } catch {}
  }

  // --- Modal (Promise-based) ---
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modalMessage  = document.getElementById('modal-message');
  const modalConfirm  = document.getElementById('modal-confirm');
  const modalCancel   = document.getElementById('modal-cancel');

  function confirmModal(message, title = 'Please Confirm', confirmLabel = 'Confirm', danger = true) {
    return new Promise(resolve => {
      document.getElementById('modal-title').textContent = title;
      modalMessage.textContent = message;
      modalConfirm.textContent = confirmLabel;
      modalConfirm.className = danger ? 'btn-red' : 'btn-amber';
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden', 'false');

      const onConfirm = () => { cleanup(); resolve(true); };
      const onCancel  = () => { cleanup(); resolve(false); };
      const onKey = (e) => { if (e.key === 'Escape') onCancel(); }

      modalConfirm.addEventListener('click', onConfirm);
      modalCancel.addEventListener('click', onCancel);
      window.addEventListener('keydown', onKey);

      function cleanup() {
        modalBackdrop.style.display = 'none';
        modalBackdrop.setAttribute('aria-hidden', 'true');
        modalConfirm.removeEventListener('click', onConfirm);
        modalCancel.removeEventListener('click', onCancel);
        window.removeEventListener('keydown', onKey);
      }
    });
  }

  // --- Actions ---
  function addSmoke(ts = Date.now()) { smokeEvents.push({ timestamp: ts }); saveEvents(); render(); }
  function addManual(timeStr) {
    if (!timeStr) return;
    const [hStr,mStr] = timeStr.split(':');
    const h = Number(hStr), m = Number(mStr);
    if (Number.isNaN(h) || Number.isNaN(m)) return;
    const d = new Date();
    d.setHours(h, m, 0, 0);
    addSmoke(d.getTime());
  }
  function undoLast() { if (smokeEvents.length) { smokeEvents.pop(); saveEvents(); render(); } }

  async function clearToday() {
    const ok = await confirmModal('Clear all entries for TODAY?', 'Reset Today', 'Clear Today', true);
    if (!ok) return;
    const s = startOfToday(), e = endOfToday();
    smokeEvents = smokeEvents.filter(ev => ev.timestamp < s || ev.timestamp >= e);
    saveEvents(); render();
  }

  async function clearHistoryDouble() {
    const ok1 = await confirmModal('This will delete ALL history. Continue?', 'Clear All History', 'Continue', true);
    if (!ok1) return;
    const ok2 = await confirmModal('Are you absolutely sure? This cannot be undone.', 'Confirm Deletion', 'Delete All', true);
    if (!ok2) return;
    smokeEvents = [];
    saveEvents(); render();
  }

  function deleteEvent(globalIndex) { smokeEvents.splice(globalIndex, 1); saveEvents(); render(); }
  function setTab(newTab) { tab = newTab; render(); }
  function shiftHistory(days) {
    const [y,m,d] = historyDate.split('-').map(Number);
    const base = new Date(y, m-1, d);
    base.setDate(base.getDate() + days);
    historyDate = toYYYYMMDD(base);
    render();
  }

  // --- Derived ---
  function dayBoundsForTab() {
    if (tab === 'today') return { dayStart: startOfToday(), dayEnd: endOfToday() };
    const [y,m,d] = historyDate.split('-').map(Number);
    const start = startOfDay(new Date(y, m-1, d));
    return { dayStart: start, dayEnd: endOfDay(new Date(start)) };
  }
  function subsetWithIndex(dayStart, dayEnd) {
    return smokeEvents
      .map((e, idx) => ({ ...e, _idx: idx }))
      .filter(e => e.timestamp >= dayStart && e.timestamp < dayEnd)
      .sort((a,b) => a.timestamp - b.timestamp);
  }
  function lastTsGlobal() {
    if (!smokeEvents.length) return null;
    return smokeEvents.reduce((m,e)=> e.timestamp>m?e.timestamp:m, 0);
  }

  // --- Chart (SVG scatter) ---
  function renderScatter(svg, items, dayStart, dayEnd) {
    const w = svg.clientWidth;
    const h = svg.clientHeight;
    const padding = { left: 40, right: 12, top: 12, bottom: 24 };
    const innerW = Math.max(10, w - padding.left - padding.right);
    const innerH = Math.max(10, h - padding.top - padding.bottom);

    svg.innerHTML = ''; // clear

    // Scales
    const xMin = dayStart, xMax = dayEnd;
    const x = ts => padding.left + ( (ts - xMin) / (xMax - xMin) ) * innerW;

    // Vertical stacking by minute to avoid overlap
    const buckets = {};
    const points = items.map(e => {
      const minuteKey = Math.floor(e.timestamp/60000);
      buckets[minuteKey] = (buckets[minuteKey]||0) + 1;
      return { x: x(e.timestamp), yLevel: buckets[minuteKey], ts: e.timestamp };
    });
    const maxLevel = Math.max(2, ...points.map(p=>p.yLevel));
    const y = lvl => padding.top + innerH - ( (lvl-1) / (maxLevel-1) ) * innerH;

    // Grid lines every 2 hours
    const gridGroup = document.createElementNS('http://www.w3.org/2000/svg','g');
    const twoH = 2 * 60 * 60 * 1000;
    for (let t = Math.ceil(dayStart / twoH) * twoH; t <= dayEnd; t += twoH) {
      const gx = x(t);
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', gx); line.setAttribute('y1', padding.top);
      line.setAttribute('x2', gx); line.setAttribute('y2', padding.top + innerH);
      line.setAttribute('class', 'grid');
      gridGroup.appendChild(line);

      const tick = document.createElementNS('http://www.w3.org/2000/svg','text');
      tick.setAttribute('x', gx); tick.setAttribute('y', padding.top + innerH + 14);
      tick.setAttribute('text-anchor', 'middle'); tick.setAttribute('class', 'tick');
      tick.textContent = new Date(t).toLocaleTimeString([], {hour12:false, hour:'2-digit'});
      gridGroup.appendChild(tick);
    }
    svg.appendChild(gridGroup);

    // Axis X
    const axisX = document.createElementNS('http://www.w3.org/2000/svg','line');
    axisX.setAttribute('x1', padding.left); axisX.setAttribute('y1', padding.top + innerH);
    axisX.setAttribute('x2', padding.left + innerW); axisX.setAttribute('y2', padding.top + innerH);
    axisX.setAttribute('class', 'axis');
    svg.appendChild(axisX);

    // Dots
    const dotsGroup = document.createElementNS('http://www.w3.org/2000/svg','g');
    points.forEach(p => {
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx', p.x);
      c.setAttribute('cy', y(p.yLevel));
      c.setAttribute('r', 5);
      c.setAttribute('class', 'dot');
      c.addEventListener('mouseenter', e => showTooltip(svg, e.clientX, e.clientY, new Date(p.ts).toLocaleTimeString([], {hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'})));
      c.addEventListener('mouseleave', hideTooltip);
      dotsGroup.appendChild(c);
    });
    svg.appendChild(dotsGroup);
  }

  // Tooltip
  let tip;
  function showTooltip(svg, clientX, clientY, text) {
    if (!tip) {
      tip = document.createElement('div');
      tip.style.position = 'fixed';
      tip.style.padding = '6px 8px';
      tip.style.background = '#111827';
      tip.style.border = '1px solid #374151';
      tip.style.borderRadius = '8px';
      tip.style.color = '#fff';
      tip.style.fontSize = '12px';
      tip.style.pointerEvents = 'none';
      tip.style.zIndex = 9999;
      document.body.appendChild(tip);
    }
    tip.textContent = text;
    tip.style.display = 'block';
    tip.style.left = (clientX + 10) + 'px';
    tip.style.top  = (clientY + 10) + 'px';
  }
  function hideTooltip() { if (tip) tip.style.display = 'none'; }

  // --- DOM refs ---
  const $ = sel => document.querySelector(sel);
  const elTodayUI = $('#today-ui');
  const elHistoryUI = $('#history-ui');

  const elTabToday = $('#tab-today');
  const elTabHist  = $('#tab-history');

  const elBtnSmoke = $('#btn-smoke');
  const elBtnUndo  = $('#btn-undo');
  const elBtnResetToday = $('#btn-reset-today');
  const elBtnClearHistory = $('#btn-clear-history');

  const elManual   = $('#manual-time');
  const elBtnAdd   = $('#btn-add-manual');

  const elCost     = $('#cost-input');
  const elSaveCost = $('#btn-save-cost');

  const elStatToday= $('#stat-today');
  const elCostToday= $('#cost-today');
  const elStatAll  = $('#stat-all');
  const elCostAll  = $('#cost-all');
  const elSince    = $('#since-last');
  const elSinceAt  = $('#since-last-at');
  const svgToday   = $('#chart-today');
  const listToday  = $('#list-today');

  const elBtnPrev  = $('#btn-prev');
  const elBtnNext  = $('#btn-next');
  const elDate     = $('#history-date');
  const elStatSel  = $('#stat-selected');
  const elCostSel  = $('#cost-selected');
  const elStatAll2 = $('#stat-all-2');
  const elCostAll2 = $('#cost-all-2');
  const elStatDate = $('#stat-date');
  const svgHist    = $('#chart-history');
  const listHist   = $('#list-history');

  // --- Events wiring ---
  elBtnSmoke.addEventListener('click', () => addSmoke());
  elBtnUndo.addEventListener('click', () => undoLast());
  elBtnResetToday.addEventListener('click', clearToday);
  elBtnClearHistory.addEventListener('click', clearHistoryDouble);
  elBtnAdd.addEventListener('click', () => addManual(elManual.value));

  elSaveCost.addEventListener('click', () => {
    const n = Number(elCost.value);
    if (!Number.isNaN(n) && n >= 0) {
      costPerCig = n;
      saveCost();
      // no render() needed; but do it to update cost labels
      render();
    } else {
      alert('Please enter a valid non-negative number for cost.');
    }
  });

  elTabToday.addEventListener('click', () => setTab('today'));
  elTabHist.addEventListener('click', () => setTab('history'));
  elBtnPrev.addEventListener('click', () => shiftHistory(-1));
  elBtnNext.addEventListener('click', () => shiftHistory(1));
  elDate.addEventListener('change', () => { historyDate = elDate.value; render(); });

  // --- Render ---
  function render() {
    // Tabs
    if (tab === 'today') {
      elTodayUI.style.display = '';
      elHistoryUI.style.display = 'none';
      elTabToday.classList.add('active');
      elTabHist.classList.remove('active');
    } else {
      elTodayUI.style.display = 'none';
      elHistoryUI.style.display = '';
      elTabToday.classList.remove('active');
      elTabHist.classList.add('active');
    }

    // Only write to the cost input if the user is NOT typing in it
    if (document.activeElement !== elCost) {
      elCost.value = costPerCig ? String(costPerCig) : '';
    }

    // Today view
    const { dayStart, dayEnd } = dayBoundsForTab();
    const dayItems = subsetWithIndex(dayStart, dayEnd);
    elStatToday.textContent = dayItems.length;
    elStatAll.textContent = smokeEvents.length;

    // Costs
    const todayCost = dayItems.length * (costPerCig || 0);
    const allCost   = smokeEvents.length * (costPerCig || 0);
    elCostToday.textContent = 'Cost: ' + fmtCurrency(todayCost);
    elCostAll.textContent   = 'Cost: ' + fmtCurrency(allCost);

    const last = lastTsGlobal();
    if (last) {
      elSince.textContent = fmtDuration(nowTs - last);
      elSinceAt.textContent = 'Last at ' + fmtTime(last);
    } else {
      elSince.textContent = '—';
      elSinceAt.textContent = '';
    }

    const hasAny = smokeEvents.length > 0;
    elBtnUndo.disabled = !hasAny;
    elBtnResetToday.disabled = !hasAny;
    elBtnClearHistory.disabled = !hasAny;

    // Today chart + list
    renderScatter(svgToday, dayItems, startOfToday(), endOfToday());
    renderList(listToday, dayItems);

    // History view
    elDate.value = historyDate;
    elStatDate.textContent = historyDate;
    const [y,m,d] = historyDate.split('-').map(Number);
    const hs = startOfDay(new Date(y, m-1, d));
    const he = endOfDay(new Date(hs));
    const histItems = subsetWithIndex(hs, he);
    elStatSel.textContent = histItems.length;
    elStatAll2.textContent = smokeEvents.length;

    // History costs
    const selCost = histItems.length * (costPerCig || 0);
    elCostSel.textContent = 'Cost: ' + fmtCurrency(selCost);
    elCostAll2.textContent = 'Cost: ' + fmtCurrency(allCost);

    renderScatter(svgHist, histItems, hs, he);
    renderList(listHist, histItems);
  }

  function renderList(ul, items) {
    ul.innerHTML = '';
    if (!items.length) {
      const li = document.createElement('li');
      li.className = 'li';
      li.style.justifyContent = 'center';
      li.textContent = 'No events logged.';
      ul.appendChild(li);
      return;
    }
    for (const e of items) {
      const li = document.createElement('li');
      li.className = 'li';
      const left = document.createElement('span');
      left.textContent = fmtTime(e.timestamp);
      const btn = document.createElement('button');
      btn.textContent = 'Delete';
      btn.className = 'btn-red';
      btn.addEventListener('click', () => deleteEvent(e._idx));
      li.appendChild(left);
      li.appendChild(btn);
      ul.appendChild(li);
    }
  }

  // Initial paint
  render();
})();
</script>
</body>
</html>
