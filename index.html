<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>Smoking Habit Tracker</title>
    <link rel="icon" href="data:," />
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-900">
    <div id="root"></div>

    <!-- React + ReactDOM (production UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Recharts UMD -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js" crossorigin></script>

    <!-- Babel to transpile JSX in-browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const {
        useState, useEffect, useMemo
      } = React;

      const {
        ResponsiveContainer,
        ScatterChart,
        Scatter,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
      } = Recharts;

      // ---- Date helpers ----
      function startOfDay(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        return d.getTime();
      }
      function endOfDay(date) {
        const d = new Date(date);
        d.setHours(24, 0, 0, 0);
        return d.getTime();
      }
      function startOfToday() { return startOfDay(new Date()); }
      function endOfToday() { return endOfDay(new Date()); }

      function formatTime(ts) {
        return new Date(ts).toLocaleTimeString([], {
          hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit"
        });
      }

      function formatDuration(ms) {
        if (ms <= 0 || !Number.isFinite(ms)) return "â€”";
        const s = Math.floor(ms / 1000);
        const hh = Math.floor(s / 3600);
        const mm = Math.floor((s % 3600) / 60);
        const ss = s % 60;
        const pad = (n) => String(n).padStart(2, "0");
        if (hh > 0) return `${hh}h ${pad(mm)}m ${pad(ss)}s`;
        return `${mm}m ${pad(ss)}s`;
      }

      const LS_KEY = "habit_smokes_v1";

      function App() {
        const [smokeEvents, setSmokeEvents] = useState([]);
        const [manualTime, setManualTime] = useState("");
        const [nowTs, setNowTs] = useState(Date.now());
        const [tab, setTab] = useState("today"); // "today" | "history"
        const [historyDate, setHistoryDate] = useState(() => {
          const d = new Date();
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          return `${y}-${m}-${day}`;
        });

        // Live ticker for "time since last"
        useEffect(() => {
          const id = setInterval(() => setNowTs(Date.now()), 1000);
          return () => clearInterval(id);
        }, []);

        // Load from localStorage
        useEffect(() => {
          try {
            const raw = localStorage.getItem(LS_KEY);
            if (raw) {
              const parsed = JSON.parse(raw);
              if (Array.isArray(parsed)) setSmokeEvents(parsed);
            }
          } catch {}
        }, []);

        // Save to localStorage
        useEffect(() => {
          try {
            localStorage.setItem(LS_KEY, JSON.stringify(smokeEvents));
          } catch {}
        }, [smokeEvents]);

        const handleSmoke = (timestamp = Date.now()) => {
          setSmokeEvents((prev) => [...prev, { timestamp }]);
        };

        const handleManualAdd = () => {
          if (!manualTime) return;
          const [hoursStr, minutesStr] = manualTime.split(":");
          const hours = Number(hoursStr);
          const minutes = Number(minutesStr);
          if (Number.isNaN(hours) || Number.isNaN(minutes)) return;
          const now = new Date();
          now.setHours(hours, minutes, 0, 0);
          handleSmoke(now.getTime());
          setManualTime("");
        };

        const handleReset = () => setSmokeEvents([]);
        const handleUndoLast = () =>
          setSmokeEvents((prev) => (prev.length ? prev.slice(0, -1) : prev));
        const deleteEvent = (globalIndex) =>
          setSmokeEvents((prev) => prev.filter((_, i) => i !== globalIndex));

        // Day bounds (today and history)
        const todayStart = useMemo(() => startOfToday(), []);
        const todayEnd = useMemo(() => endOfToday(), []);
        const historyDayStart = useMemo(() => {
          const [y, m, d] = historyDate.split("-").map(Number);
          return startOfDay(new Date(y, m - 1, d));
        }, [historyDate]);
        const historyDayEnd = useMemo(
          () => endOfDay(new Date(historyDayStart)),
          [historyDayStart]
        );

        const { dayStart, dayEnd } = useMemo(
          () =>
            tab === "today"
              ? { dayStart: todayStart, dayEnd: todayEnd }
              : { dayStart: historyDayStart, dayEnd: historyDayEnd },
          [tab, todayStart, todayEnd, historyDayStart, historyDayEnd]
        );

        // Subset for the active day with original indices
        const dayEventsWithIndex = useMemo(
          () =>
            smokeEvents
              .map((e, idx) => ({ ...e, _globalIndex: idx }))
              .filter((e) => e.timestamp >= dayStart && e.timestamp < dayEnd)
              .sort((a, b) => a.timestamp - b.timestamp),
          [smokeEvents, dayStart, dayEnd]
        );

        // Latest event time (global)
        const lastTs = useMemo(() => {
          if (!smokeEvents.length) return null;
          return smokeEvents.reduce((m, e) => (e.timestamp > m ? e.timestamp : m), 0);
        }, [smokeEvents]);

        // Vertical stacking per-minute to prevent overlap
        const data = useMemo(() => {
          const buckets = {};
          return dayEventsWithIndex.map((e) => {
            const k = Math.floor(e.timestamp / 60000);
            buckets[k] = (buckets[k] || 0) + 1;
            return { x: e.timestamp, y: buckets[k], ts: e.timestamp };
          });
        }, [dayEventsWithIndex]);

        const hasEvents = smokeEvents.length > 0;

        const shiftHistoryDate = (days) => {
          const [y, m, d] = historyDate.split("-").map(Number);
          const base = new Date(y, m - 1, d);
          base.setDate(base.getDate() + days);
          const yy = base.getFullYear();
          const mm = String(base.getMonth() + 1).padStart(2, "0");
          const dd = String(base.getDate()).padStart(2, "0");
          setHistoryDate(`${yy}-${mm}-${dd}`);
        };

        return (
          <div className="p-6 max-w-4xl mx-auto text-white">
            <h1 className="text-3xl font-bold mb-4 text-center text-yellow-400">
              Smoking Habit Tracker
            </h1>

            {/* Tabs */}
            <div className="flex justify-center gap-2 mb-6">
              <button
                onClick={() => setTab("today")}
                className={`px-4 py-2 rounded-lg text-sm font-semibold ${tab === "today" ? "bg-yellow-400 text-black" : "bg-gray-800 text-gray-200"}`}
              >
                Today
              </button>
              <button
                onClick={() => setTab("history")}
                className={`px-4 py-2 rounded-lg text-sm font-semibold ${tab === "history" ? "bg-yellow-400 text-black" : "bg-gray-800 text-gray-200"}`}
              >
                History
              </button>
            </div>

            {tab === "today" && (
              <>
                <div className="flex flex-wrap gap-3 mb-4 justify-center">
                  <button onClick={() => handleSmoke()} className="bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-2 rounded-lg">
                    I Smoked
                  </button>
                  <button
                    onClick={handleUndoLast}
                    disabled={!hasEvents}
                    className={`font-semibold px-4 py-2 rounded-lg ${hasEvents ? "bg-amber-500 hover:bg-amber-600 text-white" : "bg-gray-700 text-gray-400"}`}
                  >
                    Undo Last
                  </button>
                  <button
                    onClick={handleReset}
                    disabled={!hasEvents}
                    className={`font-semibold px-4 py-2 rounded-lg ${hasEvents ? "bg-red-500 hover:bg-red-600 text-white" : "bg-gray-700 text-gray-400"}`}
                  >
                    Reset
                  </button>
                </div>

                <div className="flex gap-2 justify-center mb-6">
                  <input
                    type="time"
                    value={manualTime}
                    onChange={(e) => setManualTime(e.target.value)}
                    className="bg-gray-800 text-white p-2 rounded-lg border border-gray-700"
                  />
                  <button
                    onClick={handleManualAdd}
                    className="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg"
                  >
                    Add Manual
                  </button>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                  <div className="bg-gray-800 rounded-xl p-4 text-center">
                    <div className="text-sm text-gray-300">Today</div>
                    <div className="text-3xl font-bold text-yellow-300">
                      {dayEventsWithIndex.length}
                    </div>
                  </div>
                  <div className="bg-gray-800 rounded-xl p-4 text-center">
                    <div className="text-sm text-gray-300">All Time</div>
                    <div className="text-3xl font-bold">{smokeEvents.length}</div>
                  </div>
                  <div className="bg-gray-800 rounded-xl p-4 text-center">
                    <div className="text-sm text-gray-300">Since last smoke</div>
                    <div className="text-2xl font-bold" aria-live="polite">
                      {lastTs ? formatDuration(nowTs - lastTs) : "â€”"}
                    </div>
                    {lastTs && (
                      <div className="text-xs text-gray-400 mt-1">
                        Last at {formatTime(lastTs)}
                      </div>
                    )}
                  </div>
                </div>

                <div className="mb-2 text-sm text-gray-300 text-center">
                  Events over the last 24 hours (midnight â†’ now)
                </div>

                <div className="h-72 bg-gray-800 p-4 rounded-lg mb-6">
                  <ResponsiveContainer width="100%" height="100%">
                    <ScatterChart>
                      <CartesianGrid strokeDasharray="3 3" stroke="#555" />
                      <XAxis
                        type="number"
                        dataKey="x"
                        domain={[dayStart, dayEnd]}
                        scale="time"
                        tickFormatter={(v) =>
                          new Date(v).toLocaleTimeString([], {
                            hour12: false,
                            hour: "2-digit",
                            minute: "2-digit",
                          })
                        }
                        stroke="#ccc"
                        label={{
                          value: "Time of day",
                          position: "insideBottom",
                          offset: -5,
                          fill: "#ccc",
                        }}
                      />
                      <YAxis type="number" dataKey="y" domain={[0, "dataMax"]} hide />
                      <Tooltip
                        labelFormatter={(v) => formatTime(v)}
                        formatter={(_, __, { payload }) => [formatTime(payload.ts), "Time"]}
                        contentStyle={{ backgroundColor: "#222", border: "none", color: "#fff" }}
                      />
                      <Scatter data={data} shape="circle" fill="#facc15" />
                    </ScatterChart>
                  </ResponsiveContainer>
                </div>

                <div className="bg-gray-800 rounded-xl p-4 mb-4">
                  <h2 className="text-lg font-bold mb-2 text-yellow-300">Today's Events</h2>
                  {dayEventsWithIndex.length === 0 ? (
                    <p className="text-gray-400">No events logged yet.</p>
                  ) : (
                    <ul className="space-y-2">
                      {dayEventsWithIndex.map((e) => (
                        <li
                          key={e._globalIndex}
                          className="flex items-center justify-between bg-gray-900 rounded-lg px-3 py-2"
                        >
                          <span className="text-white">{formatTime(e.timestamp)}</span>
                          <button
                            onClick={() => deleteEvent(e._globalIndex)}
                            className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm"
                          >
                            Delete
                          </button>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              </>
            )}

            {tab === "history" && (
              <>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-3 mb-4">
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => shiftHistoryDate(-1)}
                      className="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm"
                    >
                      â—€ Prev
                    </button>
                    <input
                      type="date"
                      value={historyDate}
                      onChange={(e) => setHistoryDate(e.target.value)}
                      className="bg-gray-800 text-white p-2 rounded-lg border border-gray-700"
                    />
                    <button
                      onClick={() => shiftHistoryDate(1)}
                      className="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm"
                    >
                      Next â–¶
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                  <div className="bg-gray-800 rounded-xl p-4 text-center">
                    <div className="text-sm text-gray-300">Selected day</div>
                    <div className="text-3xl font-bold text-yellow-300">
                      {dayEventsWithIndex.length}
                    </div>
                  </div>
                  <div className="bg-gray-800 rounded-xl p-4 text-center">
                    <div className="text-sm text-gray-300">All Time</div>
                    <div className="text-3xl font-bold">{smokeEvents.length}</div>
                  </div>
                  <div className="bg-gray-800 rounded-xl p-4 text-center">
                    <div className="text-sm text-gray-300">Date</div>
                    <div className="text-lg font-bold">{historyDate}</div>
                  </div>
                </div>

                <div className="mb-2 text-sm text-gray-300 text-center">
                  Events for {historyDate}
                </div>

                <div className="h-72 bg-gray-800 p-4 rounded-lg mb-6">
                  <ResponsiveContainer width="100%" height="100%">
                    <ScatterChart>
                      <CartesianGrid strokeDasharray="3 3" stroke="#555" />
                      <XAxis
                        type="number"
                        dataKey="x"
                        domain={[dayStart, dayEnd]}
                        scale="time"
                        tickFormatter={(v) =>
                          new Date(v).toLocaleTimeString([], {
                            hour12: false,
                            hour: "2-digit",
                            minute: "2-digit",
                          })
                        }
                        stroke="#ccc"
                        label={{
                          value: "Time of day",
                          position: "insideBottom",
                          offset: -5,
                          fill: "#ccc",
                        }}
                      />
                      <YAxis type="number" dataKey="y" domain={[0, "dataMax"]} hide />
                      <Tooltip
                        labelFormatter={(v) => formatTime(v)}
                        formatter={(_, __, { payload }) => [formatTime(payload.ts), "Time"]}
                        contentStyle={{ backgroundColor: "#222", border: "none", color: "#fff" }}
                      />
                      <Scatter data={data} shape="circle" fill="#facc15" />
                    </ScatterChart>
                  </ResponsiveContainer>
                </div>

                <div className="bg-gray-800 rounded-xl p-4 mb-4">
                  <h2 className="text-lg font-bold mb-2 text-yellow-300">
                    Events on {historyDate}
                  </h2>
                  {dayEventsWithIndex.length === 0 ? (
                    <p className="text-gray-400">No events logged.</p>
                  ) : (
                    <ul className="space-y-2">
                      {dayEventsWithIndex.map((e) => (
                        <li
                          key={e._globalIndex}
                          className="flex items-center justify-between bg-gray-900 rounded-lg px-3 py-2"
                        >
                          <span className="text-white">{formatTime(e.timestamp)}</span>
                          <button
                            onClick={() => deleteEvent(e._globalIndex)}
                            className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm"
                          >
                            Delete
                          </button>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              </>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
